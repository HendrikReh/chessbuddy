# ChessBuddy

[![OCaml](https://img.shields.io/badge/OCaml-%3E%3D%205.1-orange.svg)](https://ocaml.org)
[![Version](https://img.shields.io/badge/Version-0.0.4-blue.svg)](RELEASE_NOTES.md)
[![Status](https://img.shields.io/badge/Status-Proof%20of%20Concept-yellow.svg)](https://github.com/HendrikReh/chessbuddy)
[![Build Status](https://img.shields.io/github/actions/workflow/status/HendrikReh/chessbuddy/ci.yml?branch=main)](https://github.com/HendrikReh/chessbuddy/actions)
[![License](https://img.shields.io/github/license/HendrikReh/chessbuddy)](LICENSE)
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)](https://github.com/HendrikReh/chessbuddy)
[![Collaboration](https://img.shields.io/badge/Collaboration-Guidelines-blue.svg)](docs/GUIDELINES.md)
[![Maintenance](https://img.shields.io/badge/Maintained%3F-yes-green.svg)](https://github.com/HendrikReh/chessbuddy/graphs/commit-activity)

Retrieval system for chess training that combines a relational database (PGN games) with a vector database (FEN embeddings). Features position-level ingestion with FEN tracking, automatic deduplication, and semantic search capabilities.

<p align="center">
  <a href="#components">Components</a> •
  <a href="#getting-started">Getting Started</a>
</p>

<p align="center">
  <img src="https://img.shields.io/badge/Dependencies-Lwt%20%7C%20Postgresql%20%7C%20pgvector-blue.svg" alt="Dependencies">
  <img src="https://img.shields.io/badge/Platform-Linux%20%7C%20macOS-lightgrey.svg" alt="Platform">
  <img src="https://img.shields.io/badge/Database-PostgreSQL%2016-336791.svg" alt="PostgreSQL">
  <img src="https://img.shields.io/badge/Chess-PGN%20Ingestion-8B4513.svg" alt="Chess PGN">
</p>

## Components

- **PostgreSQL + pgvector**: Stores players, games, moves, and embeddings. Launch via `docker-compose up -d`.
- **OCaml ingestion service**: Streams PGNs, preserves comments/variations/NAGs per move, generates placeholder-board FENs with accurate metadata, and persists relational rows plus embeddings.
- **FEN Generator**: Produces placeholder-board FEN strings while keeping side-to-move, castling rights, and en-passant squares aligned with the recorded move metadata.
- **Schema definition**: `sql/schema.sql` can be applied to the Postgres instance to bootstrap tables, indexes, and helper views/materialized views for thematic queries.

## Performance (Apple M2 Pro 16GB)

Benchmarked on [TWIC 1611](https://theweekinchess.com/twic) (4.2MB, 4,875 games):

- **Ingestion**: 5:27 minutes (~15 games/sec, ~1,310 positions/sec)
- **Positions tracked**: 428,853 move-level entries
- **FEN deduplication**: 99.93% (301 unique positions)
- **Players**: 2,047 with 100% FIDE ID coverage
- **Embeddings**: 301 (one per unique FEN)

## Getting started

1. Start the database and apply the schema:

   ```bash
   mkdir -p data/db
   docker-compose up -d
   psql "postgresql://chess:chess@localhost:5433/chessbuddy" -f sql/schema.sql
   ```

2. Install dependencies (requires OCaml 5.x):

   ```bash
   opam switch create . 5.1.1
   opam install . --deps-only
   dune build
   ```

3. Run ingestion:

```bash
   dune exec bin/ingest.exe -- \
     --db-uri postgresql://chess:chess@localhost:5433/chessbuddy \
     --pgn path/to/games.pgn \
     --batch-label "mega-2024"
```

Set `OPENAI_API_KEY` before using `--enable-search-index`; the ingest CLI will abort early if the key is missing.

The executable streams PGN games, generates placeholder FENs for each position, deduplicates positions, produces embeddings (via a pluggable provider), and persists metadata ready for hybrid SQL + vector search queries.

4. Inspect batches:

   ```bash
   dune exec bin/ingest.exe -- batches list \
     --db-uri postgresql://chess:chess@localhost:5433/chessbuddy

   dune exec bin/ingest.exe -- batches show \
     --db-uri postgresql://chess:chess@localhost:5433/chessbuddy \
     --id <BATCH_ID>
   ```

   Each ingestion run records a row in `ingestion_batches` with two identifiers:
   - **Batch label** – human-friendly string you supply via `--batch-label` to tag the run (for example `dev-test`). Labels make logs easier to scan but are not required to be unique.
   - **Batch ID** – UUID primary key generated by PostgreSQL. This value links games, positions, and embeddings to the batch and is what CLI subcommands and SQL joins should use.

   Use the label for readability in dashboards or manual ops, and reach for the UUID when scripting, joining tables, or calling `batches show`.

Checksums are computed from the PGN file contents, so re-ingesting an updated file properly records a new batch. Each stored move retains pre/post comments, side-variations, and NAGs, exposing richer annotations alongside the main line.

## Documentation

### API Reference

All public modules have comprehensive `.mli` interface files with OCamldoc-compatible documentation:

- **[Database](lib/database.mli)** - PostgreSQL persistence layer with Caqti 2.x
- **[Ingestion Pipeline](lib/ingestion_pipeline.mli)** - PGN processing and batch management
- **[PGN Source](lib/pgn_source.mli)** - Parser for chess game notation
- **[Search Service](lib/search_service.mli)** - Natural language semantic search
- **[Embedder](lib/embedder.mli)** - FEN position embedders
- **[FEN Generator](lib/fen_generator.mli)** - Position notation utilities

**Generate HTML documentation:**
```bash
# Requires dependencies installed (opam install . --deps-only)
dune build @doc
# View at: _build/default/_doc/_html/chessbuddy/index.html
```

### Developer Guides

- **[Architecture](docs/ARCHITECTURE.md)** - System design, data flow, module organization, and key decisions
- **[Developer Guide](docs/DEVELOPER.md)** - Setup, testing, CLI usage
- **[Operations Guide](docs/OPERATIONS.md)** - Monitoring, troubleshooting, performance tuning, and disaster recovery
- **[Contribution Guidelines](docs/GUIDELINES.md)** - Coding standards, commit conventions, and workflow

## Development guidelines

- All OCaml modules must `open! Base` (or rely on the Base namespace) and only fall back to `Stdlib.<module>` when Base intentionally lacks an equivalent. This keeps the codebase consistent with Jane Street idioms and avoids mixing prelude semantics.
- Run `dune fmt` before submitting patches, and keep module structure aligned with the library layout in `lib/`.
- CLI wiring lives in reusable libraries (`lib/retrieve_cli.ml`, `lib/ingest_cli.ml`) that back both the executables and Alcotest suites. When adding subcommands, update the shared module first and extend the tests under `test/` so parsing behaviour stays covered without hitting a live database.

## Retrieval CLI

Use the `chessbuddy-retrieve` executable for read-side workflows:

- `retrieve similar --db-uri URI --fen FEN --k N` – compute pgvector similarity from a stored FEN embedding.
- `retrieve game --db-uri URI --id UUID [--pgn]` – print game metadata and optionally full PGN.
- `retrieve fen --db-uri URI --id UUID` – inspect a stored FEN with usage counts and embedding info.
- `retrieve player --db-uri URI --name TEXT [--limit N]` – search players by name fragment.
- `retrieve batch --db-uri URI [--id UUID | --label TEXT] [--limit N]` – summarize ingestion batches.
- `retrieve export --db-uri URI --id UUID --out FILE [--k N]` – export a FEN plus optional nearest neighbours to JSON.

**Note**: Current version (0.0.4) uses placeholder FENs with starting position board state. Full position tracking requires integration with a chess engine library.

## Testing

### Manual PostgreSQL Testing

Verify relational and vector database functionality:

```bash
# Test relational operations
psql "postgresql://chess:chess@localhost:5433/chessbuddy" << 'EOF'
INSERT INTO players (full_name, fide_id) VALUES ('Test Player', '123456') RETURNING player_id;
SELECT * FROM players;
EOF

# Test vector operations (pgvector)
psql "postgresql://chess:chess@localhost:5433/chessbuddy" << 'EOF'
INSERT INTO fens (fen_text, side_to_move, castling_rights, material_signature)
VALUES ('test/fen/8/8/8/8/8/8 w - -', 'w', '-', 'TEST') RETURNING fen_id;

INSERT INTO fen_embeddings (fen_id, embedding, embedding_version)
SELECT fen_id, array_fill(0.1::float, ARRAY[768])::vector, 'test-v1'
FROM fens WHERE fen_text = 'test/fen/8/8/8/8/8/8 w - -';

-- Similarity search using cosine distance
SELECT embedding <=> array_fill(0.2::float, ARRAY[768])::vector as distance
FROM fen_embeddings LIMIT 1;
EOF
```

### Automated Testing

Set `CHESSBUDDY_REQUIRE_DB_TESTS=1` to force database-backed tests to run; otherwise they quietly skip when PostgreSQL is unavailable (useful in CI). See [docs/DEVELOPER.md](docs/DEVELOPER.md) for more details.

`dune runtest` now exercises CLI argument parsing alongside database scenarios. The ingest and retrieve command trees are validated via `test/test_ingest_cli.ml` and `test/test_retrieve_cli.ml`, so regressions in Cmdliner wiring are caught without needing Postgres.

**Natural language search tests** live in `test/test_search_service.ml`. They rely on the same PostgreSQL setup and schema as the other integration suites, but use a stub embedder so no network calls are issued. To focus on these cases:

```bash
docker-compose up -d
psql "postgresql://chess:chess@localhost:5433/chessbuddy" -f sql/schema.sql
CHESSBUDDY_REQUIRE_DB_TESTS=1 dune runtest --only-test "Search Service"
```

Dropping the `--only-test` flag runs the full battery, including the new search coverage.

---

